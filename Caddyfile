# Caddyfile - MHTI Reverse Proxy Configuration
# =============================================
# Caddy serves as the entry point:
# - Static files (frontend)
# - API proxy to backend
# - WebSocket proxy
# - Automatic gzip compression

:8000 {
    # Gzip compression
    encode gzip

    # API proxy
    handle /api/* {
        reverse_proxy localhost:8001
    }

    # WebSocket proxy (Caddy auto-handles upgrade)
    handle /ws {
        reverse_proxy localhost:8001 {
            # 禁用超时，防止长连接被断开
            transport http {
                read_timeout 0s
                write_timeout 0s
            }
        }
    }

    # Health check proxy
    handle /health* {
        reverse_proxy localhost:8001
    }

    # Static files (frontend)
    handle {
        root * /app/static
        try_files {path} /index.html
        file_server
    }

    # Cache control for static assets
    @static {
        path *.js *.css *.woff *.woff2 *.ttf *.eot *.otf
        path *.png *.jpg *.jpeg *.gif *.ico *.svg *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # No cache for HTML
    @html {
        path *.html
    }
    header @html Cache-Control "no-cache"
}
