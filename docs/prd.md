# MEHIT 后端框架重构 - 产品需求文档 (PRD)

## 文档信息

| 属性 | 值 |
|------|-----|
| 版本 | v1.0 |
| 状态 | Draft |
| 创建日期 | 2026-01-16 |
| 项目类型 | Brownfield 重构 |

---

## 1. 概述

### 1.1 项目背景

MEHIT 是一个媒体文件刮削和整理工具，采用 Python FastAPI 后端 + Vue.js 前端的全栈架构。随着功能迭代，后端代码库出现以下问题：

- 服务类职责过重（单文件超过 50KB）
- 依赖注入模式不够优雅
- 数据访问逻辑与业务逻辑混合
- 缺少统一的接口抽象

### 1.2 重构目标

| 目标 | 描述 |
|------|------|
| 架构模式优化 | 引入 DI 容器、接口抽象、Repository 模式 |
| 代码质量提升 | 遵循 SOLID 原则，消除重复代码 |
| 性能优化 | 缓存策略、异步优化、连接池调优 |

### 1.3 范围

**包含：**
- Core 层重构
- Services 层重构
- API 层重构
- Models 层重构

**不包含：**
- 前端代码修改
- 数据库 Schema 变更
- 新功能开发

---

## 2. 当前系统分析

### 2.1 技术栈

| 组件 | 技术 |
|------|------|
| 框架 | FastAPI + Uvicorn |
| 数据库 | SQLite (aiosqlite) |
| 认证 | JWT (python-jose) |
| HTTP 客户端 | httpx |

### 2.2 代码结构

```
server/
├── api/          # 21 个路由文件
├── core/         # 7 个核心模块
├── models/       # 20 个数据模型
├── services/     # 21+ 个服务类
└── tests/        # 测试用例
```

### 2.3 识别的问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| 重复的 DI 函数 | 维护成本高 | P0 |
| 大型服务类 | 可读性差、难测试 | P0 |
| 缺少接口抽象 | 耦合度高 | P1 |
| 无缓存机制 | 性能浪费 | P1 |

---

## 3. 功能需求

### 3.1 第一阶段：核心层重构

#### Epic 1.1：重构依赖注入容器

| Story | 描述 | 优先级 |
|-------|------|--------|
| 1.1.1 | 实现泛型 DI 容器 | P0 |
| 1.1.2 | 引入 @injectable 装饰器 | P0 |
| 1.1.3 | 统一依赖声明 | P0 |
| 1.1.4 | 移除重复代码 | P0 |

#### Epic 1.2：引入服务接口抽象

| Story | 描述 | 优先级 |
|-------|------|--------|
| 1.2.1 | 定义核心服务 Protocol | P0 |
| 1.2.2 | ConfigService 接口化 | P0 |
| 1.2.3 | TMDBService 接口化 | P0 |
| 1.2.4 | 其他服务接口化 | P1 |

#### Epic 1.3：优化数据库连接管理

| Story | 描述 | 优先级 |
|-------|------|--------|
| 1.3.1 | 引入 Unit of Work 模式 | P1 |
| 1.3.2 | 连接池优化 | P1 |
| 1.3.3 | 添加连接健康检查 | P1 |

#### Epic 1.4：统一异常处理机制

| Story | 描述 | 优先级 |
|-------|------|--------|
| 1.4.1 | 定义异常层次结构 | P1 |
| 1.4.2 | 统一错误响应格式 | P1 |
| 1.4.3 | 全局异常处理器 | P1 |

### 3.2 第二阶段：服务层重构

#### Epic 2.1：拆分大型服务类

| Story | 描述 | 优先级 |
|-------|------|--------|
| 2.1.1 | 分析 ScraperService 职责 | P0 |
| 2.1.2 | 拆分刮削工作流 | P0 |
| 2.1.3 | 拆分批量处理 | P0 |
| 2.1.4 | 拆分预览功能 | P1 |
| 2.1.5 | 拆分 HistoryService | P1 |

#### Epic 2.2：引入 Repository 模式

| Story | 描述 | 优先级 |
|-------|------|--------|
| 2.2.1 | 定义 Repository 基类 | P1 |
| 2.2.2 | 实现 HistoryRepository | P1 |
| 2.2.3 | 实现 ConfigRepository | P1 |
| 2.2.4 | 实现 WatcherRepository | P1 |
| 2.2.5 | 迁移现有 Service | P1 |

#### Epic 2.3：实现缓存策略

| Story | 描述 | 优先级 |
|-------|------|--------|
| 2.3.1 | 实现内存缓存装饰器 | P1 |
| 2.3.2 | TMDB 响应缓存 | P1 |
| 2.3.3 | 配置缓存 | P1 |
| 2.3.4 | 缓存监控 | P2 |

#### Epic 2.4：优化异步处理

| Story | 描述 | 优先级 |
|-------|------|--------|
| 2.4.1 | 识别可并行操作 | P2 |
| 2.4.2 | 实现并发控制 | P2 |
| 2.4.3 | 引入任务队列 | P2 |

### 3.3 第三阶段：API 层重构

#### Epic 3.1：路由自动发现机制

| Story | 描述 | 优先级 |
|-------|------|--------|
| 3.1.1 | 实现路由自动扫描 | P1 |
| 3.1.2 | 路由装饰器标记 | P1 |
| 3.1.3 | 简化 main.py | P1 |

#### Epic 3.2：统一响应格式

| Story | 描述 | 优先级 |
|-------|------|--------|
| 3.2.1 | 定义标准响应模型 | P1 |
| 3.2.2 | 定义分页响应模型 | P1 |
| 3.2.3 | 响应包装中间件 | P1 |
| 3.2.4 | 迁移现有 API | P2 |

#### Epic 3.3：API 版本控制

| Story | 描述 | 优先级 |
|-------|------|--------|
| 3.3.1 | 设计版本策略 | P2 |
| 3.3.2 | 实现版本路由 | P2 |
| 3.3.3 | 版本弃用机制 | P2 |

### 3.4 第四阶段：模型层重构

#### Epic 4.1：统一 Pydantic 模型

| Story | 描述 | 优先级 |
|-------|------|--------|
| 4.1.1 | 定义模型基类 | P1 |
| 4.1.2 | 统一字段验证器 | P1 |
| 4.1.3 | 合并重复模型 | P1 |

#### Epic 4.2：引入 DTO 模式

| Story | 描述 | 优先级 |
|-------|------|--------|
| 4.2.1 | 分离请求 DTO | P2 |
| 4.2.2 | 分离响应 DTO | P2 |
| 4.2.3 | 定义领域实体 | P2 |
| 4.2.4 | 实现模型映射 | P2 |

---

## 4. 非功能需求

| 需求 | 描述 |
|------|------|
| 向后兼容 | API 接口保持兼容，不影响前端 |
| 测试覆盖 | 重构后测试覆盖率 ≥ 80% |
| 性能 | 响应时间不增加 |
| 文档 | 关键模块添加文档注释 |

---

## 5. 统计

| 指标 | 数量 |
|------|------|
| 阶段 | 4 |
| Epic | 13 |
| Story | 48 |
