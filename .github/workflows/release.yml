# =============================================================================
# MHTI è‡ªåŠ¨æž„å»ºä¸Žå‘å¸ƒå·¥ä½œæµ
# =============================================================================
# è§¦å‘æ¡ä»¶ï¼š
#   - æŽ¨é€å¸¦æœ‰ v* æ ¼å¼çš„æ ‡ç­¾ (å¦‚ v1.0.0)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# åŠŸèƒ½ï¼š
#   1. æž„å»ºå‰ç«¯ (Vue.js)
#   2. æž„å»º Docker å¤šæž¶æž„é•œåƒ
#   3. æŽ¨é€åˆ° Docker Hub
#   4. å¯¼å‡ºé•œåƒæ–‡ä»¶åˆ° Releases
#   5. åˆ›å»º GitHub Release
# =============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0ï¼Œä¸å¸¦ v å‰ç¼€)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  DOCKER_IMAGE: xiyan520/mhti
  REGISTRY: docker.io

jobs:
  # ===========================================================================
  # å‡†å¤‡é˜¶æ®µï¼šç¡®å®šç‰ˆæœ¬å·
  # ===========================================================================
  prepare:
    name: ðŸ“‹ å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
              IS_PRERELEASE="true"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ðŸ·ï¸ æ ‡ç­¾: v$VERSION"
          echo "ðŸš€ é¢„å‘å¸ƒ: $IS_PRERELEASE"

  # ===========================================================================
  # æž„å»ºå‰ç«¯
  # ===========================================================================
  build-frontend:
    name: ðŸŽ¨ æž„å»ºå‰ç«¯
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: web
        run: npm ci

      - name: æž„å»ºå‰ç«¯
        working-directory: web
        run: npm run build

      - name: æ‰“åŒ…å‰ç«¯æž„å»ºäº§ç‰©
        run: |
          cd web
          zip -r ../mhti-frontend-${{ needs.prepare.outputs.version }}.zip dist/

      - name: ä¸Šä¼ å‰ç«¯æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 1

      - name: ä¸Šä¼ å‰ç«¯ ZIP åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: frontend-zip
          path: mhti-frontend-${{ needs.prepare.outputs.version }}.zip
          retention-days: 1

  # ===========================================================================
  # æž„å»º Docker é•œåƒå¹¶æŽ¨é€åˆ° Docker Hub
  # ===========================================================================
  build-docker:
    name: ðŸ³ æž„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [prepare, build-frontend]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½å‰ç«¯æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/

      - name: è®¾ç½® QEMU (å¤šæž¶æž„æ”¯æŒ)
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prerelease == 'false' }}

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}

      - name: è¾“å‡ºæŽ¨é€ç»“æžœ
        run: |
          echo "âœ… Docker é•œåƒå·²æŽ¨é€åˆ° Docker Hub:"
          echo "  - ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}"
          echo "  - ${{ env.DOCKER_IMAGE }}:latest"

  # ===========================================================================
  # å¯¼å‡º Docker é•œåƒæ–‡ä»¶
  # ===========================================================================
  export-docker-image:
    name: ðŸ“¦ å¯¼å‡º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [prepare, build-docker]
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            suffix: amd64
          - platform: linux/arm64
            suffix: arm64
    steps:
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: æ‹‰å–å¹¶å¯¼å‡ºé•œåƒ (${{ matrix.suffix }})
        run: |
          # æ‹‰å–æŒ‡å®šæž¶æž„çš„é•œåƒ
          docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}

          # å¯¼å‡ºä¸º tar æ–‡ä»¶
          docker save ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }} | gzip > mhti-${{ needs.prepare.outputs.version }}-${{ matrix.suffix }}.tar.gz

          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -lh mhti-*.tar.gz
          echo "âœ… é•œåƒå·²å¯¼å‡º: mhti-${{ needs.prepare.outputs.version }}-${{ matrix.suffix }}.tar.gz"

      - name: ä¸Šä¼ é•œåƒæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.suffix }}
          path: mhti-${{ needs.prepare.outputs.version }}-${{ matrix.suffix }}.tar.gz
          retention-days: 1
          compression-level: 0  # å·²ç»æ˜¯ gzip åŽ‹ç¼©

  # ===========================================================================
  # åˆ›å»º GitHub Release
  # ===========================================================================
  release:
    name: ðŸš€ åˆ›å»º Release
    runs-on: ubuntu-latest
    needs: [prepare, build-frontend, build-docker, export-docker-image]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-assets/

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p final-assets

          # ç§»åŠ¨å‰ç«¯ ZIP
          mv release-assets/frontend-zip/*.zip final-assets/ || true

          # ç§»åŠ¨ Docker é•œåƒæ–‡ä»¶
          mv release-assets/docker-image-amd64/*.tar.gz final-assets/ || true
          mv release-assets/docker-image-arm64/*.tar.gz final-assets/ || true

          # åˆ›å»ºæºç åŒ…
          git archive --format=zip --prefix=mhti-${{ needs.prepare.outputs.version }}/ \
            -o final-assets/mhti-source-${{ needs.prepare.outputs.version }}.zip HEAD

          # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
          cd final-assets
          sha256sum *.zip *.tar.gz > SHA256SUMS.txt

          echo "ðŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -lh

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          {
            echo "changelog<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: MHTI ${{ needs.prepare.outputs.tag }}
          body: |
            ## ðŸŽ‰ MHTI ${{ needs.prepare.outputs.tag }}

            åª’ä½“æ–‡ä»¶åˆ®å‰Šä¸Žæ•´ç†å·¥å…· - è‡ªåŠ¨ä»Ž TMDB èŽ·å–å…ƒæ•°æ®

            ---

            ### ðŸ³ Docker éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

            #### ä»Ž Docker Hub æ‹‰å–

            ```bash
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            #### ä»Ž Release é•œåƒæ–‡ä»¶åŠ è½½

            ```bash
            # ä¸‹è½½å¹¶åŠ è½½é•œåƒ (æ ¹æ®æž¶æž„é€‰æ‹©)
            # AMD64 (x86_64):
            gunzip -c mhti-${{ needs.prepare.outputs.version }}-amd64.tar.gz | docker load

            # ARM64 (Apple Silicon, æ ‘èŽ“æ´¾ç­‰):
            gunzip -c mhti-${{ needs.prepare.outputs.version }}-arm64.tar.gz | docker load
            ```

            ---

            ### ðŸš€ å¿«é€Ÿå¯åŠ¨

            ```bash
            docker run -d \
              --name mhti \
              -p 8000:8000 \
              -v ./data:/app/data \
              -v /path/to/media:/media:ro \
              -e TZ=Asia/Shanghai \
              ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            #### Docker Compose

            ```yaml
            version: '3.8'
            services:
              mhti:
                image: ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
                container_name: mhti
                restart: unless-stopped
                ports:
                  - "8000:8000"
                volumes:
                  - ./data:/app/data
                  - /path/to/media:/media:ro
                environment:
                  - TZ=Asia/Shanghai
            ```

            ---

            ### ðŸ“‹ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### ðŸ“¦ ä¸‹è½½æ–‡ä»¶è¯´æ˜Ž

            | æ–‡ä»¶ | è¯´æ˜Ž |
            |------|------|
            | `mhti-*-amd64.tar.gz` | Docker é•œåƒ (x86_64/AMD64) |
            | `mhti-*-arm64.tar.gz` | Docker é•œåƒ (ARM64/Apple Silicon) |
            | `mhti-frontend-*.zip` | å‰ç«¯æž„å»ºäº§ç‰© |
            | `mhti-source-*.zip` | æºä»£ç åŒ… |
            | `SHA256SUMS.txt` | æ–‡ä»¶æ ¡éªŒå’Œ |

            ---

            ### ðŸ”— ç›¸å…³é“¾æŽ¥

            - ðŸ“– [å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
            - ðŸ³ [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE }})
            - ðŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)

          files: |
            final-assets/*
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # å‘å¸ƒå®Œæˆé€šçŸ¥
  # ===========================================================================
  notify:
    name: ðŸ“¢ å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare, release]
    if: success()
    steps:
      - name: å‘å¸ƒæˆåŠŸæ‘˜è¦
        run: |
          echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker é•œåƒ**: \`${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE }}/tags)" >> $GITHUB_STEP_SUMMARY
