# =============================================================================
# MHTI è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# =============================================================================
# è§¦å‘æ¡ä»¶ï¼š
#   - æ¨é€å¸¦æœ‰ v* æ ¼å¼çš„æ ‡ç­¾ (å¦‚ v1.0.0)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# åŠŸèƒ½ï¼š
#   1. æ„å»ºå‰ç«¯ (Vue.js)
#   2. æ„å»º Docker å¤šæ¶æ„é•œåƒ (amd64, arm64)
#   3. æ¨é€åˆ° Docker Hub
#   4. åˆ›å»º GitHub Release
# =============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰æ ¼å¼
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0ï¼Œä¸å¸¦ v å‰ç¼€)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  DOCKER_IMAGE: xiyan520/mhti
  REGISTRY: docker.io

jobs:
  # ===========================================================================
  # å‡†å¤‡é˜¶æ®µï¼šç¡®å®šç‰ˆæœ¬å·
  # ===========================================================================
  prepare:
    name: å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å· (å»æ‰ v å‰ç¼€)
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« alpha, beta, rc ç­‰)
            if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
              IS_PRERELEASE="true"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ğŸ·ï¸ æ ‡ç­¾: v$VERSION"
          echo "ğŸš€ é¢„å‘å¸ƒ: $IS_PRERELEASE"

  # ===========================================================================
  # æ„å»ºé˜¶æ®µï¼šå‰ç«¯ + Docker é•œåƒ
  # ===========================================================================
  build:
    name: æ„å»ºé•œåƒ
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: web
        run: npm ci

      - name: æ„å»ºå‰ç«¯
        working-directory: web
        run: npm run build

      - name: ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 1

      - name: è®¾ç½® QEMU (å¤šæ¶æ„æ”¯æŒ)
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            # ç‰ˆæœ¬æ ‡ç­¾
            type=semver,pattern={{version}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.prepare.outputs.version }}
            # latest æ ‡ç­¾ (ä»…éé¢„å‘å¸ƒç‰ˆæœ¬)
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prerelease == 'false' }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "ğŸ³ Docker é•œåƒå·²æ¨é€:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | while read tag; do
            echo "  - $tag"
          done

  # ===========================================================================
  # å‘å¸ƒé˜¶æ®µï¼šåˆ›å»º GitHub Release
  # ===========================================================================
  release:
    name: åˆ›å»º Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog

      - name: ä¸‹è½½å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: release-assets/dist

      - name: æ‰“åŒ…å‘å¸ƒèµ„æº
        run: |
          # åˆ›å»ºå‰ç«¯æ„å»ºåŒ…
          cd release-assets
          zip -r ../mhti-frontend-${{ needs.prepare.outputs.version }}.zip dist/
          cd ..

          # åˆ›å»ºæºç åŒ… (ä¸å« node_modules ç­‰)
          git archive --format=zip --prefix=mhti-${{ needs.prepare.outputs.version }}/ \
            -o mhti-source-${{ needs.prepare.outputs.version }}.zip HEAD

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ğŸ“ é¦–æ¬¡å‘å¸ƒï¼ŒåŒ…å«æ‰€æœ‰æäº¤"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          else
            echo "ğŸ“ ä¸ $PREVIOUS_TAG æ¯”è¾ƒçš„å˜æ›´"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          # å†™å…¥å¤šè¡Œè¾“å‡º
          {
            echo "changelog<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: MHTI ${{ needs.prepare.outputs.tag }}
          body: |
            ## ğŸ‰ MHTI ${{ needs.prepare.outputs.tag }}

            ### ğŸ“¦ Docker é•œåƒ

            ```bash
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            ### ğŸš€ å¿«é€Ÿå¯åŠ¨

            ```bash
            docker run -d \
              --name mhti \
              -p 8000:8000 \
              -v ./data:/app/data \
              -e TZ=Asia/Shanghai \
              ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            ### ğŸ“‹ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.changelog }}

            ### ğŸ“ ä¸‹è½½

            - `mhti-frontend-*.zip` - å‰ç«¯æ„å»ºäº§ç‰©
            - `mhti-source-*.zip` - æºä»£ç åŒ…

            ---

            > ğŸ“– å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          files: |
            mhti-frontend-${{ needs.prepare.outputs.version }}.zip
            mhti-source-${{ needs.prepare.outputs.version }}.zip
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # é€šçŸ¥é˜¶æ®µ (å¯é€‰)
  # ===========================================================================
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare, build, release]
    if: success()
    steps:
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… MHTI ${{ needs.prepare.outputs.tag }} å‘å¸ƒæˆåŠŸ!"
          echo ""
          echo "ğŸ“¦ Docker é•œåƒ: ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}"
          echo "ğŸ·ï¸ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}"
